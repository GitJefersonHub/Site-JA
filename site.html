<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ponto Digital</title>
  <style>
    @media (max-width: 768px) {
      body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        margin: 0;
        padding: 0;
      }

      .container-form,
      .container-folha {
        width: 94%;
        margin: 1% auto;
        background-color: #fff;
        padding: 1%;
        box-shadow: 0 0 5% rgba(0, 0, 0, 0.1);
        border-radius: 2%;
      }

      h1 {
        text-align: center;
        font-size: 200%;
        margin-bottom: 5%;
      }

      h2 {
        text-align: center;
        font-size: 100%;
        margin-bottom: 5%;
      }

      label {
        display: block;
        margin-bottom: 2%;
        font-size: 100%;
      }

      select,
      input[type="text"] {
        width: 96%;
        padding: 2%;
        font-size: 100%;
        border: 0.2% solid #ccc;
        border-radius: 1%;
        margin-bottom: 1%;
      }

      .button-group {
        display: flex;
        justify-content: space-between;
        margin-top: 5%;
      }

      button {
        padding: 2% 5%;
        font-size: 100%;
        border: none;
        border-radius: 1%;
        cursor: pointer;
        width: 48%;
      }

      button#okBtn {
        background-color: #4CAF50;
        color: white;
      }

      button#resetBtn {
        background-color: #f44336;
        color: white;
      }

      #folhaTabela {
        width: 100%;
        border-collapse: collapse;
        margin-top: 2%;
        font-size: 70%;
      }

      #folhaTabela th {
        background-color: #e0e0e0;
        font-weight: bold;
        text-align: center;
        padding: 1.5%;
        border: 0.1% solid #ccc;
        font-size: 66%;
        color: #333;
      }

      #folhaTabela td {
        text-align: center;
        padding: 1.5%;
        border: 0.1% solid #ddd;
        font-size: 60%;
        color: #555;
        background-color: #fafafa;
      }

      #folhaTabela tr:nth-child(even) td {
        background-color: #f0f0f0;
      }

      /* Estilos por tipo de registro */
      .entrada-row td {
        background-color: #e8f5e9;
        /* verde claro */
        color: #2e7d32;
        font-weight: bold;
      }

      .saida-row td {
        background-color: #ffebee;
        /* vermelho claro */
        color: #c62828;
        font-weight: bold;
      }

      .extra-row td {
        background-color: #e3f2fd;
        /* azul claro */
        color: #1565c0;
        font-weight: bold;
      }
    }
  </style>

</head>

<body>
  <div class="container-form">
    <h1>Ponto Digital</h1>
    <div id="formArea">
      <label for="posto">Posto de servi√ßo:</label>
      <select id="posto" name="posto">
        <option value="">Carregando localiza√ß√£o...</option>
      </select>
    </div>
  </div>

  <div class="container-folha">
    <h2>Folha de ponto digital</h2>
    <table id="folhaTabela" style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="background-color: #eee;">
          <th>Data</th>
          <th>Local</th>
          <th>Matr√≠cula</th>
          <th>Nome</th>
          <th>Entrada</th>
          <th>Sa√≠da</th>
          <th>Extra</th>
        </tr>
      </thead>
      <tbody>
        <!-- Linhas ser√£o adicionadas aqui -->
      </tbody>
    </table>

    <script>

      const postoSelect = document.getElementById("posto");
      const formArea = document.getElementById("formArea");
      const localFixo = "Goi√¢nia - GO";
      let nomeSelecionado = "";
      let localSelecionado = "";
      let matriculaSelecionada = ""; // üëà nova vari√°vel

      function adicionarOpcao(texto, selectElement) {
        const option = document.createElement("option");
        option.value = texto;
        option.textContent = texto;
        selectElement.appendChild(option);
      }


      async function carregarLocalizacaoAtualCom(selectElement) {
        selectElement.innerHTML = "";
        adicionarOpcao("Selecione", selectElement);

        try {
          const pos = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject);
          });

          const { latitude, longitude } = pos.coords;
          const res = await fetch(`/.netlify/functions/getAddress?lat=${latitude}&lon=${longitude}`);
          const data = await res.json();

          if (data.endereco) {
            adicionarOpcao(data.endereco, selectElement);
          } else {
            adicionarOpcao("Localiza√ß√£o atual n√£o encontrada", selectElement);
          }
        } catch (error) {
          console.error("Erro ao obter localiza√ß√£o:", error);
          adicionarOpcao("Localiza√ß√£o atual n√£o dispon√≠vel", selectElement);
        }

        adicionarOpcao(localFixo, selectElement);
      }


      function mostrarCampoMatricula() {
        localSelecionado = postoSelect.value;

        formArea.innerHTML = `
    <label for="matricula">Digite sua matr√≠cula:</label>
    <input type="text" id="matricula" name="matricula" placeholder="Matr√≠cula" />
  `;

        const inputMatricula = document.getElementById("matricula");

        inputMatricula.addEventListener("input", function () {
          const valor = inputMatricula.value.trim();

          if (valor === "1" || valor === "2") {
            matriculaSelecionada = valor; // üëà salva a matr√≠cula
            nomeSelecionado = valor === "1" ? "Jos√©" : "Maria";
            mostrarTipoRegistro(); // Pula direto para a pr√≥xima etapa
          }

        });
      }


      function mostrarTipoRegistro() {
        formArea.innerHTML = `
    <div><strong>${nomeSelecionado}</strong></div>
    <label for="tipoRegistro">Entrada / Sa√≠da:</label>
    <select id="tipoRegistro">
      <option value="">Selecione</option>
      <option value="Entrada">Entrada</option>
      <option value="Sa√≠da">Sa√≠da</option>
    </select>
    <div id="botaoContainer" class="button-group" style="display: none;">
      <button id="confirmarBtn">Confirmar</button>
      <button id="resetBtn">Reset</button>
    </div>
  `;

        const tipoRegistroSelect = document.getElementById("tipoRegistro");
        const botaoContainer = document.getElementById("botaoContainer");

        tipoRegistroSelect.addEventListener("change", () => {
          if (tipoRegistroSelect.value !== "") {
            botaoContainer.style.display = "flex";
          } else {
            botaoContainer.style.display = "none";
          }
        });

        document.getElementById("resetBtn").addEventListener("click", () => {
          resetFormulario();
        });

        document.getElementById("confirmarBtn").addEventListener("click", () => {
          const tipo = tipoRegistroSelect.value;
          if (tipo !== "") {
            mostrarResumo(tipo);
          } else {
            alert("Por favor, selecione Entrada ou Sa√≠da.");
          }
        });
      }


      function mostrarResumo(tipoRegistro) {
        const hoje = new Date();

        const dia = hoje.getDate();
        const mes = hoje.toLocaleString("pt-BR", { month: "short" });
        const diaSemana = hoje.toLocaleString("pt-BR", { weekday: "short" });

        const mesFormatado = mes.replace(".", "").charAt(0).toUpperCase() + mes.slice(1).replace(".", "");
        const diaSemanaFormatado = diaSemana.replace(".", "");

        const dataFormatada = `${dia}/${mesFormatado} - ${diaSemanaFormatado}`;

        formArea.innerHTML = `
        <h2>Resumo</h2>
        <p><strong>Data:</strong> ${dataFormatada}</p>
        <p><strong>Local:</strong> ${localSelecionado}</p>
        <p><strong>Matr√≠cula:</strong> ${matriculaSelecionada}</p>
        <p><strong>Nome:</strong> ${nomeSelecionado}</p>
        <p><strong>${tipoRegistro}:</strong> <span id="horaAtual"></span></p>
        <div style="margin-top: 30px;">
            <button id="baterPontoBtn" style="width: 100%; background-color: #2196F3; color: white; margin-bottom: 10px;">Bater o ponto</button>
            <button id="resetResumoBtn" style="width: 100%; background-color: #ff9800; color: white;">Reset</button>
        </div>
    `;

        // Atualiza o hor√°rio em tempo real
        const horaSpan = document.getElementById("horaAtual");

        function atualizarHora() {
          const agora = new Date();
          const horaFormatada = agora.toLocaleTimeString("pt-BR", {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit"
          });
          horaSpan.textContent = horaFormatada;
        }

        atualizarHora();
        setInterval(atualizarHora, 1000);

        document.getElementById("baterPontoBtn").addEventListener("click", () => {
          const horaAtual = new Date().toLocaleTimeString("pt-BR", {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit"
          });

          const tabela = document.getElementById("folhaTabela").querySelector("tbody");

          // Verifica se j√° existe uma linha para essa data/matr√≠cula/nome
          const novaLinha = document.createElement("tr");
          novaLinha.className = tipoRegistro === "Entrada"
            ? "entrada-row"
            : tipoRegistro === "Sa√≠da"
              ? "saida-row"
              : "extra-row";


          novaLinha.innerHTML = `
    <td>${dataFormatada}</td>
    <td>${localSelecionado}</td>
    <td>${matriculaSelecionada}</td>
    <td>${nomeSelecionado}</td>
    <td>${tipoRegistro === "Entrada" ? horaAtual : ""}</td>
    <td>${tipoRegistro === "Sa√≠da" ? horaAtual : ""}</td>
    <td></td>
  `;

          tabela.appendChild(novaLinha);

          alert("Ponto registrado com sucesso!");
        });


        // Evento do bot√£o "Reset"
        document.getElementById("resetResumoBtn").addEventListener("click", () => {
          resetFormulario();
        });
      }


      function resetFormulario() {
        // Limpa vari√°veis de mem√≥ria
        nomeSelecionado = "";
        localSelecionado = "";

        // Reconstr√≥i o HTML inicial
        formArea.innerHTML = `
    <label for="posto">Posto de servi√ßo:</label>
    <select id="posto" name="posto">
      <option value="">Carregando localiza√ß√£o...</option>
    </select>
  `;

        // Atualiza a refer√™ncia do select
        const novoSelect = document.getElementById("posto");

        // Reatribui o listener ao novo select
        novoSelect.addEventListener("change", () => {
          if (novoSelect.value !== "") {
            mostrarCampoMatricula();
          }
        });

        // Chama a fun√ß√£o de carregamento com o novo select
        carregarLocalizacaoAtualCom(novoSelect);
      }

      postoSelect.addEventListener("change", () => {
        if (postoSelect.value !== "") {
          mostrarCampoMatricula();
        }
      });

      window.onload = () => {
        carregarLocalizacaoAtualCom(postoSelect);
      };

    </script>

</body>

</html>